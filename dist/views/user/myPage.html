<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="/css/styles.css" />
        <link rel="stylesheet" href="/css/ai_style.css" />
        <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" rel="stylesheet" crossorigin="anonymous" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
        <script>
            $(function(){
                $(".header").load("../views/include/header.html");
                $(".sideMenu").load("../views/include/side.html");
                $(".footer").load("../views/include/footer.html");
            });

            jQuery.browser = {};
            (function () {
                jQuery.browser.msie = false;
                jQuery.browser.version = 0;
                if (navigator.userAgent.match(/MSIE ([0-9]+)\./)) {
                    jQuery.browser.msie = true;
                    jQuery.browser.version = RegExp.$1;
                }
            })();
        </script>
    </head>
    <body class="sb-nav-fixed">
        <nav class="header sb-topnav navbar navbar-expand navbar-dark bg-dark"></nav>
        <div id="layoutSidenav">
        <div class="sideMenu" id="layoutSidenav_nav"></div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid">
                        <h1 class="mt-4">회원 정보</h1>
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item active">내 정보 확인 및 수정</li>
                        </ol>
                        <div class="card mb-4 row col-sm-8" style="margin : 0 auto;">
                            <div class="card-body">
                                <form>
                                    <div class="form-row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputId">아이디</label>
                                                <input class="form-control mb-3" id="inputId" type="text" placeholder="Enter id" />

                                                <label class="small mb-1" for="inputNickName">닉네임</label>
                                                <input class="form-control" id="inputNickName" type="text" placeholder="Enter nick name" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputConfirmPassword">프로필 사진</label>
                                                <div class="profile">
                                                    <input id="inputProfile" name="Profile" class="form-control file-upload-input" type='file' onchange="readURL(this);" accept="image/*" />
                                                    <div class="drag-text">
                                                        <img src="../../img/upload.png" class="mt-5 upload"></image>
                                                    </div>
                                                </div>
                                                <div class="profile-content" style="text-align: center;">
                                                    <img class="profile-image" id="profile-image" alt="your image" style="max-width: 80%; max-height: 160px;" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row password">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputPassword">비밀번호</label>
                                                <input class="form-control" id="inputPassword" type="password" placeholder="Enter password" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputConfirmPassword">비밀번호 확인</label>
                                                <input class="form-control" id="inputConfirmPassword" type="password" placeholder="Confirm password" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputheight">키(cm)</label>
                                                <input class="form-control" id="inputheight" type="text" pattern="[0-9]+" placeholder="Enter height" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputweight">체중(kg)</label>
                                                <input class="form-control" id="inputweight" type="text" pattern="[0-9]+" placeholder="Enter weight" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputage">나이</label>
                                                <input class="form-control" id="inputage" type="text" pattern="[0-9]+" placeholder="Enter age" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputgender">성별</label>
                                                <select class="form-control" name="inputgender">
                                                    <option value="1">남자</option>
                                                    <option value="2">여자</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="small mb-1" for="inputactivity">활동량</label>
                                        <select class="form-control" name="inputactivity">
                                            <option value="1.2">거의 없다 (거의 좌식 생활을 하고 운동 안함)</option>
                                            <option value="1.375">조금 있다 (활동량이 보통이거나 주1~3회 운동)</option>
                                            <option value="1.55">보통 (활동량이 다소 많거나 주 3~5회 운동)</option>
                                            <option value="1.725">꽤 있다 (활동량이 많거나 주6~7회 운동)</option>
                                            <option value="1.9">아주 많다 (활동량이 매우 많거나, 거의 매일 하루 2번 운동)</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputgoal">목표</label>
                                                <select class="form-control" name="inputgoal">
                                                    <option value="1">유지</option>
                                                    <option value="2">벌크업</option>
                                                    <option value="3">다이어트</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            
                                        </div>
                                    </div>
                                    <div class="form-row email">
                                        <div class="col-md-6">
                                            <div class="form-group inputEmailAddress">
                                                <label class="small mb-1" for="inputEmailAddress">이메일</label>
                                                <input class="form-control" id="inputEmailAddress" type="email" aria-describedby="emailHelp" placeholder="Enter email address" />
                                            </div>
                                            <div class="form-group emailAuthNum">
                                                <label class="small mb-1" for="emailAuthNum">인증 번호 입력</label>
                                                <input class="form-control" id="emailAuthNum" type="text" placeholder="Enter Authentication Number" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group emailAuth">
                                                <label class="small mb-1" for="emailAuth">인증</label>
                                                <input class="form-control" id="emailAuth" type="button" value="이메일 인증"/>
                                            </div>
                                            <div class="form-group emailConfirm">
                                                <label class="small mb-1" for="emailConfirm">인증</label>
                                                <input class="form-control" id="emailConfirm" type="button" value="인증 확인"/>
                                            </div>
                                            <div class="form-group emailComplete">
                                                <label class="small mb-1" for="emailComplete">인증</label>
                                                <input class="form-control" id="emailComplete" type="button" value="인증 완료" disabled/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group mt-4 mb-4 updateInput"><a class="btn btn-primary btn-block" onclick="updateInput()">수정</a></div>
                                    <div class="form-group mt-4 mb-4 update"><a class="btn btn-primary btn-block" onclick="update()">회원정보수정</a></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
                <footer class="footer py-4 bg-light mt-auto"></footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script>
            var nowFilePath, nowFile;

            $(function() {
                $('.password').hide();
                $('.email').hide();
                $('.profile').hide();
                $('.update').hide();
                $('.emailAuthNum').hide();
                $('.emailConfirm').hide();
                $('.emailComplete').hide();

                $("#inputId").attr("disabled", true);
                $("#inputNickName").attr("disabled", true);
                $("#inputheight").attr("disabled", true);
                $("#inputweight").attr("disabled", true);
                $("#inputage").attr("disabled", true);
                $("select[name = inputgender]").attr("disabled", true);
                $("select[name = inputgoal]").attr("disabled", true);
                $("select[name = inputactivity]").attr("disabled", true);
                
                ajax();

                $('.profile-content').on('click', function(event) {
                    if(!$("#inputNickName").is(":disabled")) {
                        var result = confirm("삭제하시겠습니까?")
    
                        if(result) {
                            removeUpload();
                        } else {
                            return false;
                        }
                    }
                });

                $('#emailAuth').on('click', function(event) {
                    email = $('#inputEmailAddress').val();
                    var result = confirm(email + " 이 이메일이 맞나요?")

                    if(result) {
                        alert("이메일을 확인해주세요.")
                        emailAuthentication();
                    } else {
                        return false;
                    }
                });

                $('#emailConfirm').on('click', function(event) {
                    emailAuthNum = $('#emailAuthNum').val();

                    if(Number(emailAuthNum) == emailNum) {
                        alert("이메일 인증이 완료되었습니다.");
                        $('.emailConfirm').hide();
                        $('.emailComplete').show();
                    } else {
                        alert("이메일 인증 번호를 확인해주세요.");
                    }
                });

                $('#myForm').submit(function() {
                    return false;
                });
            });

            function ajax() {
                var jsonArray = {
                    id : getCookie("userData")
                }

                $.ajax({
                    url:'/user/myPage/detail', // 요청 할 주소    
                    type:'POST', // GET, PUT
                    data: JSON.stringify(jsonArray), // 전송할 데이터
                    contentType: "application/json",
                    dataType:'JSON',// xml, json, script, html
                    //beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                    success:function(data) {
                        var fileName = data[0].Profile.split('/')[data[0].Profile.split('/').length - 1];
                        if(fileName == "profile.png") {
                            $("#profile-image").attr("src", "../../img/profile.png");
                        } else {
                            $("#profile-image").attr("src", "../../upload/" + fileName);
                        }
                        
                        $('#inputId').val(data[0].ID);
                        $('#inputNickName').val(data[0].Nickname);
                        $('#inputheight').val(data[0].Height);
                        $('#inputweight').val(data[0].Weight);
                        $('#inputage').val(data[0].Age);
                        $('#inputPassword').val(data[0].Password);
                        $('select[name = inputgender]').val(data[0].Gender).prop("selected", true);;
                        $('select[name = inputgoal]').val(data[0].Goal).prop("selected", true);;
                        $('select[name = inputactivity]').val(data[0].Activity).prop("selected", true);;
                        $('#inputEmailAddress').val(data[0].Email);

                        fileBlob($("#profile-image").attr("src"), fileName);

                        var id = $('#inputId');
                        var nickName = $('#inputNickName');

                        id.addClass('py-4');
                        nickName.addClass('py-4');
                    },// 요청 완료 시
                    error:function(data) {
                        console.log("error")
                    },// 요청 실패.
                    //complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
                });
            }

            function updateInput() {
                $('.password').show();
                $('.email').show();
                $('.updateInput').hide();
                $('.update').show();

                $("#inputNickName").attr("disabled", false);
                $("#inputheight").attr("disabled", false);
                $("#inputweight").attr("disabled", false);
                $("#inputage").attr("disabled", false);
                $("select[name = inputgender]").attr("disabled", false);
                $("select[name = inputgoal]").attr("disabled", false);
                $("select[name = inputactivity]").attr("disabled", false);
            }

            function update() {
                var img = false
                if($('#inputNickName').val() == "") {
                    alert("닉네임을 입력 해주세요.");
                    return false;
                }
                if($('#inputPassword').val() == "") {
                    alert("비밀번호를 입력 해주세요.");
                    return false;
                }
                if($('#inputConfirmPassword').val() == "") {
                    alert("비밀번호 확인를 입력 해주세요.");
                    return false;
                }
                if($('#inputheight').val() == "") {
                    alert("키를 입력 해주세요.");
                    return false;
                }
                if($('#inputweight').val() == "") {
                    alert("체중을 입력 해주세요.");
                    return false;
                }
                if($('#inputage').val() == "") {
                    alert("나이를 입력 해주세요.");
                    return false;
                }
                if($("input:invalid").length != 0) {
                    alert("형식을 확인해주세요.")
                    return false;
                }
                if($(".emailComplete").css("display") == "none") {
                    alert("이메일 인증을 진행해주세요.");
                    return false;
                }
                if($('#inputProfile')[0].files[0] == undefined && $('#profile-image').attr("src") == undefined) {
                    var result = confirm("기본 프로필 사진으로 이용하시겠습니까?");

                    if(result) {
                        var img = true
                    } else {
                        return false;
                    }
                }

                var id = $('#inputId').val();
                var nickName = $('#inputNickName').val();
                var profile = img?"":$('#inputProfile')[0].files[0]||nowFile;
                var pw = $('#inputPassword').val();
                var confirmPw = $('#inputConfirmPassword').val();
                var height = $('#inputheight').val();
                var weight = $('#inputweight').val();
                var age = $('#inputage').val();
                var gender = $('select[name = inputgender]').val();
                var goal = $('select[name = inputgoal]').val();
                var activity = $('select[name = inputactivity]').val();
                var email = $('#inputEmailAddress').val();

                if(pw == confirmPw) {
                    var formData = new FormData();
    
                    formData.append("id", id);
                    formData.append("nickName", nickName);
                    formData.append("Profile", profile);
                    formData.append("pw", pw);
                    formData.append("weight", weight);
                    formData.append("height", height);
                    formData.append("gender", gender);
                    formData.append("age", age);
                    formData.append("goal", goal);
                    formData.append("activity", activity);
                    formData.append("email", email);
    
                    $.ajax({
                        url:'/user/myPage/check', // 요청 할 주소        
                        type:'POST', // GET, PUT
                        data: formData, // 전송할 데이터
                        processData: false,    // 반드시 작성
                        contentType: false,    // 반드시 작성
                        dataType:'TEXT',// xml, json, script, html
                        //beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                        success:function(data) {
                            if(data == "success") {
                                alert("회원정보수정이 완료되었습니다.")
                                location.href="/diary"
                            } else {
                                alert("오류! 관리자에게 문의하세요.")
                                return false;
                            }
                        },// 요청 완료 시
                        error:function(data) {
                            alert("오류! 관리자에게 문의하세요.")
                            return false;
                        },// 요청 실패.
                        //complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
                    });
                } else {
                    alert("비밀번호를 확인해주세요.")
                    return false;
                }
            }

            function emailAuthentication() {
                $('.emailAuthNum').show();
                $('.emailConfirm').show();
                
                $('.inputEmailAddress').hide();
                $('.emailAuth').hide();
                
                var email = $('#inputEmailAddress').val();

                var emailData = {
                    email : email
                }

                $.ajax({
                    url:'/user/email/check', // 요청 할 주소    
                    type:'POST', // GET, PUT
                    data : JSON.stringify(emailData),
                    contentType: "application/json",
                    dataType:'JSON',// xml, json, script, html
                    //beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                    success:function(data) {
                        emailNum = data.num
                    },// 요청 완료 시
                    error:function(data) {
                        alert("오류! 관리자에게 문의하세요.")
                        return false;
                    },// 요청 실패.
                    //complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
                });
            }

            function readURL(input) {
                if (input.files && input.files[0]) {
                    var id = $('#inputId');
                    var nickName = $('#inputNickName');

                    id.addClass('py-4');
                    nickName.addClass('py-4');

                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('.profile').hide();

                        $('.profile-image').attr('src', e.target.result);
                        $('.profile-content').show();
                    };

                    reader.readAsDataURL(input.files[0]);
                } else {
                    removeUpload();
                }
            }

            function removeUpload() {
                var id = $('#inputId');
                var nickName = $('#inputNickName');

                id.removeClass('py-4');
                nickName.removeClass('py-4');

                if ($.browser.msie) { 
                    // ie 일때 input[type=file] init.
                    $(".file-upload-input").replaceWith($(".file-upload-input").clone(true));
                } else { 
                    // other browser 일때input[type=file] init.
                    $(".file-upload-input").val("");
                }
                
                $("#profile-image").attr("src", null);
                $('.profile-content').hide();
                $('.profile').show();
            }

            function fileBlob(filePath, fileName) {
                var GetFileBlobUsingURL = function (url, convertBlob) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", url);
                    xhr.responseType = "blob";
                    xhr.addEventListener('load', function() {
                        convertBlob(xhr.response);
                    });
                    xhr.send();
                };

                var blobToFile = function (blob, name) {
                        blob.lastModifiedDate = new Date();
                        blob.name = name;
                        return blob;
                };

                var GetFileObjectFromURL = function(filePathOrUrl, convertBlob) {
                    GetFileBlobUsingURL(filePathOrUrl, function (blob) {
                        convertBlob(blobToFile(blob, fileName));
                    });
                };

                GetFileObjectFromURL(filePath, function (fileObject) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        nowFilePath = e.target.result;
                    };

                    reader.readAsDataURL(fileObject);
                    nowFile = fileObject
                });
            }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
        </script>
        <style>
            .profile-content:hover {
                cursor: pointer;
            }
        </style>
    </body>
</html>
