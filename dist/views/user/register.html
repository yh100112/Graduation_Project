<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="/css/styles.css"/>
        <link rel="stylesheet" href="/css/ai_style.css" />
        <script type="text/javascript" src="/scripts/jquery/dist/jquery.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
        <script>
            jQuery.browser = {};
            (function () {
                jQuery.browser.msie = false;
                jQuery.browser.version = 0;
                if (navigator.userAgent.match(/MSIE ([0-9]+)\./)) {
                    jQuery.browser.msie = true;
                    jQuery.browser.version = RegExp.$1;
                }
            })();
        </script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js" crossorigin="anonymous"></script> -->
    </head>
    <body>
        <div id="layoutAuthentication">
            <div id="layoutAuthentication_content" style="background: url('../img/login.jpg'); background-repeat:no-repeat; background-size: cover;">
                <main>
                    <div class="container mb-5">
                        <div class="row">
                            <div class="col-lg-7">
                                <div class="card shadow-lg border-0 rounded-lg mt-5">
                                    <div class="card-header"><h3 class="text-center font-weight-light my-4">회원가입</h3></div>
                                    <div class="card-body">
                                        <form id="myForm">
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputId">아이디</label>
                                                        <input class="form-control mb-3" id="inputId" type="text" placeholder="Enter id" />

                                                        <label class="small mb-1" for="inputNickName">닉네임</label>
                                                        <input class="form-control" id="inputNickName" type="text" placeholder="Enter nick name" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputConfirmPassword">프로필 사진</label>
                                                        <div class="profile">
                                                            <input id="inputProfile" name="Profile" class="form-control file-upload-input" type='file' onchange="readURL(this);" accept="image/*" />
                                                            <div class="drag-text">
                                                                <img src="../../img/upload.png" class="mt-5 upload"></image>
                                                            </div>
                                                        </div>
                                                        <div class="profile-content" style="text-align: center;">
                                                            <img class="profile-image" id="profile-image" alt="your image" style="max-width: 80%; max-height: 160px;" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputPassword">비밀번호</label>
                                                        <input class="form-control" id="inputPassword" type="password" placeholder="Enter password" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputConfirmPassword">비밀번호 확인</label>
                                                        <input class="form-control" id="inputConfirmPassword" type="password" placeholder="Confirm password" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputheight">키(cm)</label>
                                                        <input class="form-control" id="inputheight" type="text" pattern="[0-9]+" placeholder="Enter height" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputweight">체중(kg)</label>
                                                        <input class="form-control" id="inputweight" type="text" pattern="[0-9]+" placeholder="Enter weight" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputage">나이</label>
                                                        <input class="form-control" id="inputage" type="text" pattern="[0-9]+" placeholder="Enter age" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputgender">성별</label>
                                                        <select class="form-control" name="inputgender">
                                                            <option value="1">남자</option>
                                                            <option value="2">여자</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="small mb-1" for="inputactivity">활동량</label>
                                                <select class="form-control" name="inputactivity">
                                                    <option value="1.2">거의 없다 (거의 좌식 생활을 하고 운동 안함)</option>
                                                    <option value="1.375">조금 있다 (활동량이 보통이거나 주1~3회 운동)</option>
                                                    <option value="1.55">보통 (활동량이 다소 많거나 주 3~5회 운동)</option>
                                                    <option value="1.725">꽤 있다 (활동량이 많거나 주6~7회 운동)</option>
                                                    <option value="1.9">아주 많다 (활동량이 매우 많거나, 거의 매일 하루 2번 운동)</option>
                                                </select>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small mb-1" for="inputgoal">목표</label>
                                                        <select class="form-control" name="inputgoal">
                                                            <option value="1">유지</option>
                                                            <option value="2">벌크업</option>
                                                            <option value="3">다이어트</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-group inputEmailAddress">
                                                        <label class="small mb-1" for="inputEmailAddress">이메일</label>
                                                        <input class="form-control" id="inputEmailAddress" type="email" aria-describedby="emailHelp" placeholder="Enter email address" />
                                                    </div>
                                                    <div class="form-group emailAuthNum">
                                                        <label class="small mb-1" for="emailAuthNum">인증 번호 입력</label>
                                                        <input class="form-control" id="emailAuthNum" type="text" placeholder="Enter Authentication Number" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group emailAuth">
                                                        <label class="small mb-1" for="emailAuth">인증</label>
                                                        <input class="form-control" id="emailAuth" type="button" value="이메일 인증"/>
                                                    </div>
                                                    <div class="form-group emailConfirm">
                                                        <label class="small mb-1" for="emailConfirm">인증</label>
                                                        <input class="form-control" id="emailConfirm" type="button" value="인증 확인"/>
                                                    </div>
                                                    <div class="form-group emailComplete">
                                                        <label class="small mb-1" for="emailComplete">인증</label>
                                                        <input class="form-control" id="emailComplete" type="button" value="인증 완료" disabled/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group mt-4 mb-0"><input class="btn btn-primary btn-block" type="submit" onclick="create()" value="회원 가입"></div>
                                        </form>
                                    </div>
                                    <div class="card-footer text-center">
                                        <div class="small"><a href="/user/login">로그인 하러가기</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
            <div id="layoutAuthentication_footer">
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; calorie guide Website 2021</div>
                            <div>
                                <a href="#">Privacy Policy</a>
                                &middot;
                                <a href="#">Teams &amp; calorie guide</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <!-- <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script>
            var emailNum = "";
            $(function() {
                $('.emailAuthNum').hide();
                $('.emailConfirm').hide();
                $('.emailComplete').hide();

                $('.profile-content').hide();

                $('.profile-content').on('click', function(event) {
                    var result = confirm("삭제하시겠습니까?")

                    if(result) {
                        removeUpload();
                    } else {
                        return false;
                    }
                });

                $('#emailAuth').on('click', function(event) {
                    email = $('#inputEmailAddress').val();
                    var result = confirm(email + " 이 이메일이 맞나요?")

                    if(result) {
                        alert("이메일을 확인해주세요.")
                        emailAuthentication();
                    } else {
                        return false;
                    }
                });

                $('#emailConfirm').on('click', function(event) {
                    emailAuthNum = $('#emailAuthNum').val();

                    if(Number(emailAuthNum) == emailNum) {
                        alert("이메일 인증이 완료되었습니다.");
                        $('.emailConfirm').hide();
                        $('.emailComplete').show();
                    } else {
                        alert("이메일 인증 번호를 확인해주세요.");
                    }
                });

                $('#myForm').submit(function() {
                    return false;
                });
            })

            function readURL(input) {
                if (input.files && input.files[0]) {
                    var id = $('#inputId');
                    var nickName = $('#inputNickName');

                    id.addClass('py-4');
                    nickName.addClass('py-4');

                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('.profile').hide();

                        $('.profile-image').attr('src', e.target.result);
                        $('.profile-content').show();
                    };

                    reader.readAsDataURL(input.files[0]);
                } else {
                    removeUpload();
                }
            }

            function removeUpload() {
                var id = $('#inputId');
                var nickName = $('#inputNickName');

                id.removeClass('py-4');
                nickName.removeClass('py-4');

                if ($.browser.msie) { 
                    // ie 일때 input[type=file] init.
                    $(".file-upload-input").replaceWith($(".file-upload-input").clone(true));
                } else { 
                    // other browser 일때input[type=file] init.
                    $(".file-upload-input").val("");
                }

                $("#profile-image").attr("src", null);
                $('.profile-content').hide();
                $('.profile').show();
            }

            $('.profile').bind('dragover', function () {
                $('.profile').addClass('image-dropping');
            });
            $('.profile').bind('dragleave', function () {
                $('.profile').removeClass('image-dropping');
            });

            function create() {
                var img = false
                if($('#inputId').val() == "") {
                    alert("아이디를 입력 해주세요.");
                    return false;
                }
                if($('#inputNickName').val() == "") {
                    alert("닉네임을 입력 해주세요.");
                    return false;
                }
                if($('#inputPassword').val() == "") {
                    alert("비밀번호를 입력 해주세요.");
                    return false;
                }
                if($('#inputConfirmPassword').val() == "") {
                    alert("비밀번호 확인를 입력 해주세요.");
                    return false;
                }
                if($('#inputheight').val() == "") {
                    alert("키를 입력 해주세요.");
                    return false;
                }
                if($('#inputweight').val() == "") {
                    alert("체중을 입력 해주세요.");
                    return false;
                }
                if($('#inputage').val() == "") {
                    alert("나이를 입력 해주세요.");
                    return false;
                }
                if($("input:invalid").length != 0) {
                    alert("형식을 확인해주세요.")
                    return false;
                }
                if($(".emailComplete").css("display") == "none") {
                    alert("이메일 인증을 진행해주세요.");
                    return false;
                }
                if($('#inputProfile')[0].files[0] == undefined) {
                    var result = confirm("기본 프로필 사진으로 이용하시겠습니까?");

                    if(result) {
                        var img = true
                    } else {
                        return false;
                    }
                }

                var id = $('#inputId').val();
                var nickName = $('#inputNickName').val();
                var profile = img?"":$('#inputProfile')[0].files[0];
                var pw = $('#inputPassword').val();
                var confirmPw = $('#inputConfirmPassword').val();
                var height = $('#inputheight').val();
                var weight = $('#inputweight').val();
                var age = $('#inputage').val();
                var gender = $('select[name = inputgender]').val();
                var goal = $('select[name = inputgoal]').val();
                var activity = $('select[name = inputactivity]').val();
                var email = $('#inputEmailAddress').val();

                if(pw == confirmPw) {
                    var formData = new FormData();
    
                    formData.append("id", id);
                    formData.append("nickName", nickName);
                    formData.append("Profile", profile);
                    formData.append("pw", pw);
                    formData.append("weight", weight);
                    formData.append("height", height);
                    formData.append("gender", gender);
                    formData.append("age", age);
                    formData.append("goal", goal);
                    formData.append("activity", activity);
                    formData.append("email", email);
    
                    $.ajax({
                        url:'/user/register/check', // 요청 할 주소        
                        type:'POST', // GET, PUT
                        data: formData, // 전송할 데이터
                        processData: false,    // 반드시 작성
                        contentType: false,    // 반드시 작성
                        dataType:'TEXT',// xml, json, script, html
                        //beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                        success:function(data) {
                            if(data == "success") {
                                alert("회원가입이 완료되었습니다.")
                                location.href="/user/login"
                            } else {
                                alert("오류! 관리자에게 문의하세요.")
                                return false;
                            }
                        },// 요청 완료 시
                        error:function(data) {
                            alert("오류! 관리자에게 문의하세요.")
                            return false;
                        },// 요청 실패.
                        //complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
                    });
                } else {
                    alert("비밀번호를 확인해주세요.")
                    return false;
                }
            }

            function emailAuthentication() {
                $('.emailAuthNum').show();
                $('.emailConfirm').show();
                
                $('.inputEmailAddress').hide();
                $('.emailAuth').hide();
                
                var email = $('#inputEmailAddress').val();

                var emailData = {
                    email : email
                }

                $.ajax({
                    url:'/user/email/check', // 요청 할 주소    
                    type:'POST', // GET, PUT
                    data : JSON.stringify(emailData),
                    contentType: "application/json",
                    dataType:'JSON',// xml, json, script, html
                    //beforeSend:function(jqXHR) {},// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                    success:function(data) {
                        emailNum = data.num
                    },// 요청 완료 시
                    error:function(data) {
                        alert("오류! 관리자에게 문의하세요.")
                        return false;
                    },// 요청 실패.
                    //complete:function(jqXHR) {}// 요청의 실패, 성공과 상관 없이 완료 될 경우 호출
                });
            }
        </script>
        <style>
            .profile-content:hover {
                cursor: pointer;
            }
        </style>
    </body>
</html>
